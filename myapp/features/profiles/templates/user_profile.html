{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - MediSafe{% endblock %}

{% block extra_css %}
<style>
    :root {
        --ink: #0f172a;
        --blue: #0B3D91;
        --blue2: #1E3A8A;
        --red: #DC2626;
        --bg: #E6F0FF;
        --gray: #64748b;
        --border: #e2e8f0;
        --light-bg: #f5f7fa;
    }

    body {
        background: var(--light-bg);
        color: var(--ink);
    }

    .container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .header-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--ink);
    }

    .header-actions {
        display: flex;
        gap: 1rem;
    }

    .btn {
        padding: 0.6rem 1.5rem;
        border: 2px solid var(--blue);
        background: transparent;
        color: var(--blue);
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s;
    }

    .btn:hover {
        background: var(--blue);
        color: white;
    }

    .btn-primary {
        background: var(--blue);
        color: white;
        border-color: var(--blue);
    }

    .btn-primary:hover {
        background: var(--blue2);
        border-color: var(--blue2);
    }

    .btn-icon {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Profile Grid */
    .profile-grid {
        display: grid;
        grid-template-columns: 400px 1fr 350px;
        gap: 2rem;
        margin-bottom: 3rem;
    }

    /* Enhanced Profile Card - Larger Panel */
    .profile-card {
        background: white;
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

    .profile-card:hover {
        box-shadow: 0 8px 24px rgba(11, 61, 145, 0.15);
        border-color: var(--blue);
    }

    .profile-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, var(--blue) 0%, #00a8e8 50%, var(--blue2) 100%);
    }

    /* Enhanced Avatar */
    .avatar {
        width: 180px;
        height: 180px;
        margin: 0 auto 1.5rem;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--bg) 0%, var(--blue) 100%);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        color: white;
        box-shadow: 0 8px 24px rgba(11, 61, 145, 0.3);
        border: 8px solid white;
        position: relative;
    }

    .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-badge {
        position: absolute;
        bottom: 0;
        right: 0;
        background: #10b981;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        border: 3px solid white;
    }

    .profile-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--ink);
        margin-bottom: 0.5rem;
    }

    .profile-role {
        color: var(--blue);
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        background: var(--bg);
        padding: 0.4rem 1rem;
        border-radius: 20px;
        display: inline-block;
    }

    .profile-status {
        color: var(--gray);
        font-size: 0.9rem;
        margin-bottom: 2rem;
    }

    .profile-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid var(--border);
    }

    .stat-item {
        background: var(--light-bg);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--blue);
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--gray);
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .profile-contact {
        text-align: left;
    }

    .contact-item {
        display: flex;
        align-items: center;
        margin-bottom: 1.2rem;
        font-size: 0.95rem;
        padding: 0.75rem;
        background: var(--light-bg);
        border-radius: 8px;
        transition: all 0.3s;
    }

    .contact-item:hover {
        background: var(--bg);
        transform: translateX(4px);
    }

    .contact-item i {
        color: var(--blue);
        width: 24px;
        margin-right: 1rem;
        font-size: 1.1rem;
    }

    .contact-item span {
        color: var(--ink);
        font-weight: 500;
    }

    .profile-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 2rem;
    }

    .profile-action-btn {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid var(--border);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: var(--blue);
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .profile-action-btn:hover {
        background: var(--blue);
        color: white;
        border-color: var(--blue);
        transform: translateY(-2px);
    }

    /* Info Sections */
    .info-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .section-header {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--ink);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
    }

    .section-header i {
        color: var(--blue);
        margin-right: 0.75rem;
        font-size: 1.3rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .info-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .info-label {
        color: var(--gray);
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .info-value {
        color: var(--ink);
        font-weight: 600;
        font-size: 0.95rem;
    }

    .info-value.empty {
        color: var(--gray);
        font-style: italic;
    }

    /* Tabs Section */
    .tabs-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .tabs-container {
        border-bottom: 2px solid var(--border);
        margin-bottom: 2rem;
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .tab-button {
        background: none;
        border: none;
        padding: 1rem 0;
        cursor: pointer;
        color: var(--gray);
        font-weight: 600;
        font-size: 0.95rem;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        margin-bottom: -2px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tab-button.active {
        color: var(--blue);
        border-bottom-color: var(--blue);
    }

    .tab-button:hover {
        color: var(--blue);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .visit-item {
        padding: 1.2rem;
        background: var(--light-bg);
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid var(--blue);
        transition: all 0.3s;
    }

    .visit-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateX(4px);
    }

    .visit-item:last-child {
        margin-bottom: 0;
    }

    .visit-date {
        color: var(--gray);
        font-size: 0.85rem;
        font-weight: 600;
    }

    .visit-doctor {
        font-weight: 600;
        color: var(--ink);
        margin: 0.5rem 0;
        font-size: 1rem;
    }

    .visit-status {
        font-size: 0.85rem;
        color: var(--gray);
        display: inline-block;
        background: white;
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        margin-top: 0.5rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--gray);
    }

    .empty-state i {
        font-size: 2.5rem;
        color: var(--border);
        margin-bottom: 1rem;
    }

    /* Completion Bar */
    .completion-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .completion-header {
        font-size: 1rem;
        font-weight: 700;
        color: var(--ink);
        margin-bottom: 1rem;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--border);
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--blue) 0%, #00a8e8 100%);
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .completion-text {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: var(--gray);
    }

    /* Responsive Design */
    @media (max-width: 1199px) {
        .profile-grid {
            grid-template-columns: 1fr 1fr;
        }

        .avatar {
            width: 150px;
            height: 150px;
            font-size: 3rem;
        }
    }

    @media (max-width: 767px) {
        .profile-grid {
            grid-template-columns: 1fr;
        }

        .header {
            flex-direction: column;
            align-items: flex-start;
        }

        .header-actions {
            width: 100%;
            margin-top: 1rem;
            flex-direction: column;
        }

        .btn {
            width: 100%;
            text-align: center;
        }

        .tabs-container {
            gap: 1rem;
        }

        .tab-button {
            padding: 0.75rem 0;
            font-size: 0.85rem;
        }

        .profile-card {
            padding: 1.5rem;
        }

        .avatar {
            width: 120px;
            height: 120px;
            font-size: 2.5rem;
        }

        .profile-name {
            font-size: 1.2rem;
        }

        .profile-stats {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 480px) {
        .container {
            padding: 0 0.5rem;
        }

        .header-title {
            font-size: 1.5rem;
        }

        .profile-card {
            padding: 1rem;
        }

        .header-actions {
            flex-direction: column;
        }

        .tabs-container {
            flex-direction: column;
            gap: 0;
        }

        .tab-button {
            padding: 0.75rem;
            width: 100%;
            justify-content: center;
            border-radius: 6px;
            margin-bottom: 0;
            border: 1px solid var(--border);
        }

        .tab-button.active {
            background: var(--bg);
            border-color: var(--blue);
        }
    }

    /* Edit Mode Styles */
    .edit-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--blue);
        border-radius: 6px;
        font-size: 0.95rem;
        font-family: inherit;
        background: white;
        color: var(--ink);
        transition: all 0.3s;
        margin-top: 0.5rem;
    }

    .edit-input:focus {
        outline: none;
        border-color: var(--blue2);
        box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
    }

    .edit-input[type="date"],
    .edit-input[type="tel"],
    .edit-input[type="email"] {
        font-family: inherit;
    }

    .edit-input[type="textarea"],
    textarea.edit-input {
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }

    .btn-cancel {
        background: var(--red) !important;
        border-color: var(--red) !important;
    }

    .btn-cancel:hover {
        background: #b91c1c !important;
        border-color: #b91c1c !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header with Actions -->
    <div class="header">
        <div class="header-title">
            <i class="fas fa-user-circle" style="margin-right: 0.75rem; color: var(--blue);"></i>My Profile
        </div>
        <div class="header-actions">
            <button class="btn" onclick="window.print()">
                <span class="btn-icon"><i class="fas fa-print"></i> PRINT</span>
            </button>
            <button class="btn btn-primary" onclick="editProfile()">
                <span class="btn-icon"><i class="fas fa-edit"></i> EDIT PROFILE</span>
            </button>
        </div>
    </div>

    <!-- Your Trusted Doctors Dropdown Section -->
    <div class="trusted-doctors-dropdown" style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 2rem; border: 2px solid transparent; transition: all 0.3s;">
        <button onclick="toggleDoctorsDropdown()" style="width: 100%; display: flex; align-items: center; justify-content: space-between; background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; font-weight: 700; color: var(--ink);" aria-expanded="false" id="doctorsToggleBtn">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-user-md" style="color: var(--blue); font-size: 20px;"></i>
                <span>Your Trusted Doctors</span>
                <span style="background: var(--blue); color: white; padding: 2px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">{{ user_doctors|length }}</span>
            </div>
            <i class="fas fa-chevron-down" id="doctorsChevron" style="color: var(--gray); transition: transform 0.3s ease;"></i>
        </button>
        <div id="doctorsContent" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 2px solid #e2e8f0;">
            {% if user_doctors %}
                {% for doctor in user_doctors %}
                    <div style="padding: 16px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #2c71b7; transition: all 0.2s ease;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-size: 17px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
                                    <i class="fas fa-stethoscope" style="color: #2c71b7; margin-right: 8px;"></i>
                                    Dr. {{ doctor.user.userprofile.first_name }} {{ doctor.user.userprofile.last_name }}
                                </div>
                                <div style="color: #64748b; font-size: 14px;">
                                    <i class="fas fa-briefcase-medical" style="margin-right: 6px;"></i>
                                    {% if doctor.specialization %}{{ doctor.specialization }}{% else %}General Practice{% endif %}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <a href="{% url 'consultations' %}" style="padding: 10px 16px; background: linear-gradient(135deg, #2c71b7, #1e5a9a); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 13px; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(44, 113, 183, 0.3); white-space: nowrap;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(44, 113, 183, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(44, 113, 183, 0.3)'">
                                    <i class="fas fa-calendar-check"></i> Appointments
                                </a>
                                <a href="{% url 'prescriptions' %}" style="padding: 10px 16px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 13px; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(34, 197, 94, 0.3); white-space: nowrap;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(34, 197, 94, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(34, 197, 94, 0.3)'">
                                    <i class="fas fa-prescription"></i> Prescriptions
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 24px; color: #64748b;">
                    <i class="fas fa-user-md" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                    <p style="margin: 0; font-size: 15px;">No doctors yet. Book your first appointment to get started!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Profile Completion Section -->
    {% if profile_completion %}
    <div class="completion-section">
        <div class="completion-header">
            <i class="fas fa-chart-pie" style="margin-right: 0.5rem; color: var(--blue);"></i>Profile Completion
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ profile_completion }}%"></div>
        </div>
        <div class="completion-text">{{ profile_completion }}% Complete - Keep your profile up to date!</div>
    </div>
    {% endif %}

    <!-- Profile Information Grid -->
    <div class="profile-grid">
        <!-- Left: Enhanced Profile Card -->
        <div class="profile-card">
            <div class="avatar">
                {% if user_profile.photo_url %}
                    <img src="{{ user_profile.photo_url }}" alt="Profile Picture">
                {% else %}
                    <i class="fas fa-user"></i>
                {% endif %}
                <div class="avatar-badge">âœ“</div>
            </div>
            <div class="profile-name">{{ user_profile.first_name|default:"" }} {{ user_profile.last_name|default:"User" }}</div>
            <div class="profile-role">{{ user.role|upper }}</div>
            <div class="profile-status">Member since {{ user.date_joined|date:"M d, Y" }}</div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-number">{{ recent_appointments|length|default:"0" }}</div>
                    <div class="stat-label">Appointments</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ recent_prescriptions|length|default:"0" }}</div>
                    <div class="stat-label">Prescriptions</div>
                </div>
            </div>
            
            <div class="profile-contact">
                <div class="contact-item">
                    <i class="fas fa-envelope"></i>
                    <span>{{ user.email }}</span>
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <span>{{ user_profile.contact_number|default:"Not provided" }}</span>
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone-alt"></i>
                    <span>{{ user_profile.phone_number|default:"Not provided" }}</span>
                </div>
                <div class="contact-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ user_profile.address|default:"Not provided" }}</span>
                </div>
            </div>

            <div class="profile-actions">
                <button class="profile-action-btn" title="Message Admin" onclick="openMessageModal()">
                    <i class="fas fa-envelope"></i>
                </button>
                <button class="profile-action-btn" title="Settings" onclick="openSettingsModal()">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="profile-action-btn" title="Download Profile">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>

        <!-- Center: Personal Information -->
        <div class="info-section">
            <div class="section-header">
                <i class="fas fa-user-card"></i> Personal Information
            </div>
            
            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Full Name</div>
                    <div class="info-value">
                        {% if user_profile.first_name and user_profile.last_name %}
                            {{ user_profile.first_name }} 
                            {% if user_profile.middle_name %}{{ user_profile.middle_name }}{% endif %}
                            {{ user_profile.last_name }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Date of Birth</div>
                    <div class="info-value">
                        {% if user_profile.birthday %}
                            {{ user_profile.birthday|date:"F d, Y" }}
                            <span style="color: var(--gray); font-weight: 400;">
                                ({{ computed_age|default:"Age" }} years old)
                            </span>
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Sex</div>
                    <div class="info-value">
                        {% if user_profile.sex %}
                            {{ user_profile.sex|upper }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Civil Status</div>
                    <div class="info-value">
                        {% if user_profile.civil_status %}
                            {{ user_profile.civil_status|title }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ user.email }}</div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Address</div>
                    <div class="info-value">
                        {% if user_profile.address %}
                            {{ user_profile.address }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Data Privacy Consent</div>
                    <div class="info-value">
                        {% if user_profile.data_privacy_consent %}
                            <span style="color: #10b981; font-weight: 700;">âœ“ GIVEN</span>
                            <span style="color: var(--gray); font-weight: 400;">
                                on {{ user_profile.consent_date|date:"M d, Y" }}
                            </span>
                        {% else %}
                            <span class="empty">Not given</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Contact Information -->
        <div class="info-section">
            <div class="section-header">
                <i class="fas fa-phone-square"></i> Contact Details
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Contact Number</div>
                    <div class="info-value">
                        {% if user_profile.contact_number %}
                            {{ user_profile.contact_number }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Phone Number</div>
                    <div class="info-value">
                        {% if user_profile.phone_number %}
                            {{ user_profile.phone_number }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Phone Type</div>
                    <div class="info-value">
                        {% if user_profile.phone_type %}
                            {{ user_profile.phone_type|title }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Emergency Contact Person</div>
                    <div class="info-value">
                        {% if user_profile.contact_person %}
                            {{ user_profile.contact_person }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Relationship to Patient</div>
                    <div class="info-value">
                        {% if user_profile.relationship_to_patient %}
                            {{ user_profile.relationship_to_patient|title }}
                        {% else %}
                            <span class="empty">Not provided</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="info-row">
                <div style="width: 100%;">
                    <div class="info-label">Member Since</div>
                    <div class="info-value">{{ user.date_joined|date:"F d, Y" }}</div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;">
            <h2 style="margin: 0; color: var(--blue); font-size: 24px; font-weight: 800;">
                <i class="fas fa-cog" style="margin-right: 10px;"></i>Settings
            </h2>
            <button onclick="closeSettingsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); padding: 5px;" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="settings-content">
            <!-- Account Settings -->
            <div class="settings-section" style="margin-bottom: 25px;">
                <h3 style="color: var(--blue); font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center;">
                    <i class="fas fa-user-cog" style="margin-right: 8px;"></i>Account Settings
                </h3>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="settings-btn" onclick="changePassword()" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-key" style="margin-right: 12px; color: var(--blue);"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--ink);">Change Password</div>
                                <div style="font-size: 12px; color: var(--muted);">Update your account password</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--muted);"></i>
                    </button>
                    
                    <button class="settings-btn" onclick="updateNotifications()" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-bell" style="margin-right: 12px; color: var(--blue);"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--ink);">Notification Settings</div>
                                <div style="font-size: 12px; color: var(--muted);">Manage your notification preferences</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--muted);"></i>
                    </button>
                </div>
            </div>
            
            <!-- Privacy Settings -->
            <div class="settings-section" style="margin-bottom: 25px;">
                <h3 style="color: var(--blue); font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center;">
                    <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>Privacy & Security
                </h3>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="settings-btn" onclick="privacySettings()" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-user-shield" style="margin-right: 12px; color: var(--blue);"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--ink);">Privacy Settings</div>
                                <div style="font-size: 12px; color: var(--muted);">Control who can see your information</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--muted);"></i>
                    </button>
                    
                    <button class="settings-btn" onclick="downloadData()" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-download" style="margin-right: 12px; color: var(--blue);"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--ink);">Download My Data</div>
                                <div style="font-size: 12px; color: var(--muted);">Export your profile and medical data</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--muted);"></i>
                    </button>
                </div>
            </div>
            
            <!-- Help & Support -->
            <div class="settings-section">
                <h3 style="color: var(--blue); font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center;">
                    <i class="fas fa-question-circle" style="margin-right: 8px;"></i>Help & Support
                </h3>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="settings-btn" onclick="contactSupport()" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-headset" style="margin-right: 12px; color: var(--blue);"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--ink);">Contact Support</div>
                                <div style="font-size: 12px; color: var(--muted);">Get help with your account</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--muted);"></i>
                    </button>
                    
                    <button class="settings-btn" onclick="viewHelp()" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-book" style="margin-right: 12px; color: var(--blue);"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--ink);">Help Center</div>
                                <div style="font-size: 12px; color: var(--muted);">Browse help articles and FAQs</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--muted);"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Admin Modal -->
<div id="messageModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;">
            <h2 style="margin: 0; color: var(--blue); font-size: 24px; font-weight: 800;">
                <i class="fas fa-envelope" style="margin-right: 10px;"></i>Message Admin
            </h2>
            <button onclick="closeMessageModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); padding: 5px;" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="messageForm" onsubmit="sendMessageToAdmin(event)">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--ink);">Title</label>
                <input type="text" id="messageTitle" required maxlength="200" placeholder="Enter message title" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='#e2e8f0'">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--ink);">Message</label>
                <textarea id="messageBody" required rows="6" placeholder="Enter your message to the admin" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeMessageModal()" style="padding: 12px 24px; background: #f1f5f9; color: var(--ink); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                    Cancel
                </button>
                <button type="submit" id="sendMessageBtn" style="padding: 12px 24px; background: linear-gradient(135deg, var(--blue), var(--blue2)); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(11, 61, 145, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(11, 61, 145, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(11, 61, 145, 0.3)'">
                    <i class="fas fa-paper-plane" style="margin-right: 6px;"></i>Send Message
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function switchTab(e, tabName) {
        // Hide all tab contents
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => content.classList.remove('active'));

        // Remove active class from all buttons
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach(btn => btn.classList.remove('active'));

        // Show selected tab and mark button as active
        document.getElementById(tabName).classList.add('active');
        e.target.closest('.tab-button').classList.add('active');
    }

    function toggleDoctorsDropdown() {
        const content = document.getElementById('doctorsContent');
        const chevron = document.getElementById('doctorsChevron');
        const btn = document.getElementById('doctorsToggleBtn');
        
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            chevron.style.transform = 'rotate(180deg)';
            btn.setAttribute('aria-expanded', 'true');
        } else {
            content.style.display = 'none';
            chevron.style.transform = 'rotate(0deg)';
            btn.setAttribute('aria-expanded', 'false');
        }
    }

    function openMessageModal() {
        const modal = document.getElementById('messageModal');
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }

    function closeMessageModal() {
        const modal = document.getElementById('messageModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            // Reset form
            document.getElementById('messageForm').reset();
        }
    }

    async function sendMessageToAdmin(event) {
        event.preventDefault();
        
        const title = document.getElementById('messageTitle').value;
        const message = document.getElementById('messageBody').value;
        const sendBtn = document.getElementById('sendMessageBtn');
        
        if (!title || !message) {
            alert('Please fill in both title and message fields.');
            return;
        }
        
        // Disable button and show loading state
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 6px;"></i>Sending...';
        
        try {
            const response = await fetch('{% url "send_message_to_admin" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    title: title,
                    message: message
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show success message
                alert('✓ Message sent successfully!\n\nYour message has been sent to the admin team. They will review it and respond as soon as possible.');
                
                // Close modal
                closeMessageModal();
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Error: ' + (error.message || 'Failed to send message. Please try again.'));
        } finally {
            // Re-enable button
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 6px;"></i>Send Message';
        }
    }

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
        const messageModal = document.getElementById('messageModal');
        if (messageModal) {
            messageModal.addEventListener('click', function(e) {
                if (e.target === messageModal) {
                    closeMessageModal();
                }
            });
        }
    });

    let isEditMode = false;
    let originalValues = {};

    function editProfile() {
        if (isEditMode) {
            // Cancel edit mode
            cancelEdit();
            return;
        }
        
        // Enable edit mode
        isEditMode = true;
        const editBtn = document.querySelector('.btn-primary');
        if (editBtn) {
            editBtn.innerHTML = '<span class="btn-icon"><i class="fas fa-times"></i> CANCEL</span>';
            editBtn.classList.add('btn-cancel');
        }

        // Store original values
        originalValues = {
            first_name: '{{ user_profile.first_name|default:"" }}',
            middle_name: '{{ user_profile.middle_name|default:"" }}',
            last_name: '{{ user_profile.last_name|default:"" }}',
            sex: '{{ user_profile.sex|default:"" }}',
            birthday: '{{ user_profile.birthday|date:"Y-m-d"|default:"" }}',
            address: '{{ user_profile.address|default:""|escapejs }}',
            contact_number: '{{ user_profile.contact_number|default:"" }}',
            phone_number: '{{ user_profile.phone_number|default:"" }}',
            phone_type: '{{ user_profile.phone_type|default:"" }}',
            contact_person: '{{ user_profile.contact_person|default:"" }}',
            relationship_to_patient: '{{ user_profile.relationship_to_patient|default:"" }}',
            civil_status: '{{ user_profile.civil_status|default:"" }}'
        };

        // Convert display values to input fields
        convertToEditMode();
    }

    function cancelEdit() {
        isEditMode = false;
        const editBtn = document.querySelector('.btn-primary');
        if (editBtn) {
            editBtn.innerHTML = '<span class="btn-icon"><i class="fas fa-edit"></i> EDIT PROFILE</span>';
            editBtn.classList.remove('btn-cancel');
        }
        convertToViewMode();
    }

    function convertToEditMode() {
        // Handle Full Name separately (it's a composite field)
        const fullNameRow = Array.from(document.querySelectorAll('.info-row')).find(row => {
            const label = row.querySelector('.info-label');
            return label && label.textContent.trim() === 'Full Name';
        });
        
        if (fullNameRow) {
            const valueEl = fullNameRow.querySelector('.info-value');
            if (valueEl) {
                valueEl.style.display = 'none';
                
                // Create three input fields for first, middle, last name
                const nameContainer = document.createElement('div');
                nameContainer.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin-top: 0.5rem;';
                
                const firstNameInput = document.createElement('input');
                firstNameInput.type = 'text';
                firstNameInput.className = 'edit-input';
                firstNameInput.placeholder = 'First Name';
                firstNameInput.value = originalValues.first_name || '';
                firstNameInput.setAttribute('data-field', 'first_name');
                nameContainer.appendChild(firstNameInput);
                
                const middleNameInput = document.createElement('input');
                middleNameInput.type = 'text';
                middleNameInput.className = 'edit-input';
                middleNameInput.placeholder = 'Middle Name';
                middleNameInput.value = originalValues.middle_name || '';
                middleNameInput.setAttribute('data-field', 'middle_name');
                nameContainer.appendChild(middleNameInput);
                
                const lastNameInput = document.createElement('input');
                lastNameInput.type = 'text';
                lastNameInput.className = 'edit-input';
                lastNameInput.placeholder = 'Last Name';
                lastNameInput.value = originalValues.last_name || '';
                lastNameInput.setAttribute('data-field', 'last_name');
                nameContainer.appendChild(lastNameInput);
                
                valueEl.parentElement.appendChild(nameContainer);
            }
        }
        
        // Convert all other info-value elements to input fields
        document.querySelectorAll('.info-value').forEach(valueEl => {
            const labelEl = valueEl.previousElementSibling;
            if (!labelEl || !labelEl.classList.contains('info-label')) return;
            
            const label = labelEl.textContent.trim();
            if (label === 'Full Name') return; // Skip, already handled
            
            const currentValue = valueEl.textContent.trim().replace(/\s*\(.*?\)\s*/g, '').replace('Not provided', '').trim();
            
            // Create input based on field type
            let input;
            const fieldName = getFieldName(label);
            
            if (fieldName === 'sex') {
                input = document.createElement('select');
                input.className = 'edit-input';
                input.innerHTML = `
                    <option value="">Select Sex</option>
                    <option value="male" ${originalValues.sex === 'male' ? 'selected' : ''}>Male</option>
                    <option value="female" ${originalValues.sex === 'female' ? 'selected' : ''}>Female</option>
                    <option value="other" ${originalValues.sex === 'other' ? 'selected' : ''}>Other</option>
                `;
            } else if (fieldName === 'birthday') {
                input = document.createElement('input');
                input.type = 'date';
                input.className = 'edit-input';
                input.value = originalValues.birthday || '';
            } else if (fieldName === 'address') {
                input = document.createElement('textarea');
                input.className = 'edit-input';
                input.rows = 3;
                input.value = originalValues.address || '';
            } else if (fieldName === 'phone_type') {
                input = document.createElement('select');
                input.className = 'edit-input';
                input.innerHTML = `
                    <option value="">Select Phone Type</option>
                    <option value="mobile" ${originalValues.phone_type === 'mobile' ? 'selected' : ''}>Mobile</option>
                    <option value="home" ${originalValues.phone_type === 'home' ? 'selected' : ''}>Home</option>
                    <option value="work" ${originalValues.phone_type === 'work' ? 'selected' : ''}>Work</option>
                    <option value="other" ${originalValues.phone_type === 'other' ? 'selected' : ''}>Other</option>
                `;
            } else if (fieldName === 'civil_status') {
                input = document.createElement('select');
                input.className = 'edit-input';
                input.innerHTML = `
                    <option value="">Select Civil Status</option>
                    <option value="single" ${originalValues.civil_status === 'single' ? 'selected' : ''}>Single</option>
                    <option value="married" ${originalValues.civil_status === 'married' ? 'selected' : ''}>Married</option>
                    <option value="divorced" ${originalValues.civil_status === 'divorced' ? 'selected' : ''}>Divorced</option>
                    <option value="widowed" ${originalValues.civil_status === 'widowed' ? 'selected' : ''}>Widowed</option>
                    <option value="separated" ${originalValues.civil_status === 'separated' ? 'selected' : ''}>Separated</option>
                `;
            } else {
                input = document.createElement('input');
                input.type = fieldName.includes('email') ? 'email' : fieldName.includes('phone') || fieldName.includes('contact') ? 'tel' : 'text';
                input.className = 'edit-input';
                input.value = originalValues[fieldName] || currentValue;
            }
            
            input.setAttribute('data-field', fieldName);
            valueEl.style.display = 'none';
            valueEl.parentElement.appendChild(input);
        });

        // Add photo upload functionality
        const avatar = document.querySelector('.avatar');
        if (avatar && !avatar.querySelector('.photo-upload-btn')) {
            const uploadBtn = document.createElement('button');
            uploadBtn.className = 'photo-upload-btn';
            uploadBtn.innerHTML = '<i class="fas fa-camera"></i> Change Photo';
            uploadBtn.style.cssText = 'position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;';
            uploadBtn.onclick = (e) => {
                e.stopPropagation();
                document.getElementById('photoFileInput')?.click();
            };
            avatar.style.position = 'relative';
            avatar.appendChild(uploadBtn);
        }

        // Add password change section
        if (!document.getElementById('passwordChangeSection')) {
            const profileCard = document.querySelector('.profile-card');
            const passwordSection = document.createElement('div');
            passwordSection.id = 'passwordChangeSection';
            passwordSection.style.cssText = 'margin-top: 1.5rem; padding: 1rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;';
            passwordSection.innerHTML = `
                <div style="font-weight: 700; color: var(--ink); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-key"></i> Change Password
                </div>
                <div style="display: grid; gap: 1rem;">
                    <div style="position: relative;">
                        <label style="font-weight: 600; color: var(--ink); margin-bottom: 0.5rem; display: block; font-size: 0.9rem;">New Password</label>
                        <input type="password" id="patient-new-password" placeholder="Enter new password" style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem;">
                        <button type="button" onclick="togglePasswordVisibility('patient-new-password')" style="position: absolute; right: 10px; top: 38px; background: none; border: none; cursor: pointer; color: var(--gray); font-size: 1.1rem;"><i class="fas fa-eye"></i></button>
                    </div>
                    <div style="position: relative;">
                        <label style="font-weight: 600; color: var(--ink); margin-bottom: 0.5rem; display: block; font-size: 0.9rem;">Confirm Password</label>
                        <input type="password" id="patient-confirm-password" placeholder="Confirm new password" style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem;">
                        <button type="button" onclick="togglePasswordVisibility('patient-confirm-password')" style="position: absolute; right: 10px; top: 38px; background: none; border: none; cursor: pointer; color: var(--gray); font-size: 1.1rem;"><i class="fas fa-eye"></i></button>
                    </div>
                    <button type="button" onclick="updatePatientPassword()" style="background: #ffc107; color: var(--ink); border: none; padding: 0.65rem 1.25rem; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.9rem;">Update Password</button>
                </div>
            `;
            profileCard.appendChild(passwordSection);
        }

        // Add save button
        if (!document.getElementById('saveProfileBtn')) {
            const saveBtn = document.createElement('button');
            saveBtn.id = 'saveProfileBtn';
            saveBtn.className = 'btn btn-primary';
            saveBtn.style.cssText = 'margin-top: 1rem; width: 100%;';
            saveBtn.innerHTML = '<span class="btn-icon"><i class="fas fa-save"></i> SAVE CHANGES</span>';
            saveBtn.onclick = saveProfile;
            document.querySelector('.profile-card').appendChild(saveBtn);
        }
    }

    function convertToViewMode() {
        // Remove name container if it exists
        const nameContainer = document.querySelector('.info-row .edit-input[data-field="first_name"]')?.parentElement;
        if (nameContainer && nameContainer.style.display.includes('grid')) {
            const fullNameRow = nameContainer.closest('.info-row');
            const valueEl = fullNameRow?.querySelector('.info-value');
            if (valueEl) {
                valueEl.style.display = '';
            }
            nameContainer.remove();
        }
        
        // Remove all input fields and restore display values
        document.querySelectorAll('.edit-input').forEach(input => {
            const valueEl = input.previousElementSibling;
            if (valueEl && valueEl.classList.contains('info-value')) {
                valueEl.style.display = '';
            }
            input.remove();
        });

        // Remove photo upload button
        const uploadBtn = document.querySelector('.photo-upload-btn');
        if (uploadBtn) uploadBtn.remove();

        // Remove password change section
        const passwordSection = document.getElementById('passwordChangeSection');
        if (passwordSection) passwordSection.remove();

        // Remove save button
        const saveBtn = document.getElementById('saveProfileBtn');
        if (saveBtn) saveBtn.remove();
    }

    function getFieldName(label) {
        const mapping = {
            'Full Name': 'first_name',
            'Date of Birth': 'birthday',
            'Sex': 'sex',
            'Civil Status': 'civil_status',
            'Address': 'address',
            'Contact Number': 'contact_number',
            'Phone Number': 'phone_number',
            'Phone Type': 'phone_type',
            'Emergency Contact Person': 'contact_person',
            'Relationship to Patient': 'relationship_to_patient'
        };
        return mapping[label] || label.toLowerCase().replace(/\s+/g, '_');
    }

    async function saveProfile() {
        const saveBtn = document.getElementById('saveProfileBtn');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="btn-icon"><i class="fas fa-spinner fa-spin"></i> SAVING...</span>';
        }

        const formData = new FormData();
        
        // Collect all input values
        document.querySelectorAll('.edit-input').forEach(input => {
            const fieldName = input.getAttribute('data-field');
            if (fieldName && input.value) {
                formData.append(fieldName, input.value);
            }
        });

        // Handle photo upload if selected
        const photoInput = document.getElementById('photoFileInput');
        if (photoInput && photoInput.files && photoInput.files[0]) {
            formData.append('photo', photoInput.files[0]);
        }

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.match(/csrftoken=([^;]+)/)?.[1];

        try {
            const response = await fetch('/api/update-profile/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData,
                credentials: 'same-origin'
            });

            // Check if response is JSON
            const contentType = response.headers.get('content-type') || '';
            let data;
            
            if (contentType.includes('application/json')) {
                data = await response.json();
            } else {
                // If not JSON, it's likely an HTML error page
                const text = await response.text();
                throw new Error(`Server returned an error (${response.status}). Please try again.`);
            }

            if (data.success) {
                // Update avatar image if photo was uploaded
                if (data.profile && data.profile.photo_url) {
                    const avatarImg = document.querySelector('.avatar img');
                    if (avatarImg) {
                        avatarImg.src = data.profile.photo_url;
                    }
                }
                
                alert('Profile updated successfully!');
                window.location.reload();
            } else {
                throw new Error(data.error || data.message || 'Failed to update profile');
            }
        } catch (error) {
            console.error('Error saving profile:', error);
            alert('Error: ' + (error.message || 'Failed to save profile. Please try again.'));
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span class="btn-icon"><i class="fas fa-save"></i> SAVE CHANGES</span>';
            }
        }
    }

    // Photo upload handler
    document.addEventListener('DOMContentLoaded', function() {
        // Create hidden file input for photo upload
        const photoInput = document.createElement('input');
        photoInput.type = 'file';
        photoInput.id = 'photoFileInput';
        photoInput.accept = 'image/*';
        photoInput.style.display = 'none';
        photoInput.onchange = function(e) {
            if (!e.target.files || !e.target.files[0]) return;
            
            const file = e.target.files[0];
            
            // Preview the selected photo
            const reader = new FileReader();
            reader.onload = function(event) {
                const avatarImg = document.querySelector('.avatar img');
                if (avatarImg) {
                    avatarImg.src = event.target.result;
                }
            };
            reader.readAsDataURL(file);
            
            // Show a message that photo will be saved when clicking Save Changes
            const uploadBtn = document.querySelector('.photo-upload-btn');
            if (uploadBtn) {
                uploadBtn.innerHTML = '<i class="fas fa-check"></i> Photo Selected';
                uploadBtn.style.background = 'rgba(34, 197, 94, 0.8)';
            }
        };
        document.body.appendChild(photoInput);
    });

    // Settings Modal Functions
    function openSettingsModal() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = 'flex';
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.9)';
        modal.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
            modal.style.opacity = '1';
            modal.style.transform = 'scale(1)';
        }, 10);
        
        // Add event listener to close modal when clicking outside
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeSettingsModal();
            }
        });
        
        // Add keyboard shortcut to close modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeSettingsModal();
            }
        });
    }
    
    function closeSettingsModal() {
        const modal = document.getElementById('settingsModal');
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.9)';
        
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    
    // Password Visibility Toggle
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = input.nextElementSibling;
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Update Patient Password
    async function updatePatientPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validation
        if (!newPassword || !confirmPassword) {
            alert('Please fill in both password fields');
            return;
        }
        
        if (newPassword.length < 8) {
            alert('Password must be at least 8 characters long');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            alert('Passwords do not match');
            return;
        }
        
        try {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const response = await fetch('{% url "patient_change_password" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    new_password: newPassword,
                    confirm_password: confirmPassword
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Password updated successfully!');
                // Clear password fields
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                alert(data.error || 'Failed to update password');
            }
        } catch (error) {
            console.error('Error updating password:', error);
            alert('Error updating password. Please try again.');
        }
    }

    // Settings Actions
    function changePassword() {
        alert('Change Password feature will be implemented soon. Please contact support for password changes.');
    }
    
    function updateNotifications() {
        alert('Notification settings will be available soon. Currently, you receive notifications for appointments and lab results.');
    }
    
    function privacySettings() {
        alert('Privacy settings panel will be implemented soon. Your data is currently protected according to our privacy policy.');
    }
    
    function downloadData() {
        if (confirm('This will download all your profile and medical data in PDF format. Continue?')) {
            // Create a simple data export
            const data = {
                profile: '{{ user.get_full_name|escapejs }}',
                email: '{{ user.email|escapejs }}',
                joined: '{{ user.date_joined|date:"Y-m-d"|escapejs }}',
                export_date: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'medisafe_profile_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Your profile data has been downloaded successfully!');
        }
    }
    
    function contactSupport() {
        if (confirm('This will open your email client to send a message to MediSafe support. Continue?')) {
            window.location.href = 'mailto:medisafe.medicalpateros@gmail.com?subject=Support Request - Profile Settings&body=Hello MediSafe Support Team,%0A%0AI need assistance with my account settings.%0A%0AUser: {{ user.get_full_name|escapejs }}%0AEmail: {{ user.email|escapejs }}%0A%0APlease describe your issue below:%0A';
        }
    }
    
    function viewHelp() {
        alert('Help Center will be available soon. For immediate assistance, please use the Contact Support option.');
    }
    
    // Add hover effects to settings buttons
    document.addEventListener('DOMContentLoaded', function() {
        const settingsButtons = document.querySelectorAll('.settings-btn');
        settingsButtons.forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                this.style.background = '#e2e8f0';
                this.style.borderColor = 'var(--blue)';
                this.style.transform = 'translateY(-1px)';
            });
            
            btn.addEventListener('mouseleave', function() {
                this.style.background = '#f8fafc';
                this.style.borderColor = '#e2e8f0';
                this.style.transform = 'translateY(0)';
            });
        });
    });

    // Message Modal Functions
    function openMessageModal() {
        document.getElementById('messageModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeMessageModal() {
        document.getElementById('messageModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('messageTitle').value = '';
        document.getElementById('messageBody').value = '';
    }

    async function sendMessageToAdmin() {
        const title = document.getElementById('messageTitle').value.trim();
        const body = document.getElementById('messageBody').value.trim();
        const submitBtn = document.getElementById('sendMessageBtn');

        if (!title || !body) {
            alert('Please fill in both title and message fields.');
            return;
        }

        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.match(/csrftoken=([^;]+)/)?.[1];

        try {
            const response = await fetch('/api/send-message-to-admin/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    title: title,
                    message: body
                }),
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (data.success) {
                alert('Message sent successfully! The admin will be notified.');
                closeMessageModal();
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Error: ' + (error.message || 'Failed to send message. Please try again.'));
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Message';
        }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('messageModal');
        if (event.target === modal) {
            closeMessageModal();
        }
    });
</script>

<!-- Message Modal -->
<div id="messageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div style="background: white; border-radius: 16px; padding: 0; width: 90%; max-width: 550px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: slideDown 0.3s ease;">
        <!-- Modal Header -->
        <div style="background: linear-gradient(135deg, #2c71b7 0%, #1e5a9a 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-envelope" style="font-size: 24px;"></i>
                <h3 style="margin: 0; font-size: 22px; font-weight: 700;">Send Message to Admin</h3>
            </div>
            <button onclick="closeMessageModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div style="padding: 30px;">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 700; color: #1e293b; margin-bottom: 8px; font-size: 15px;">
                    <i class="fas fa-heading" style="color: #2c71b7; margin-right: 8px;"></i>Title
                </label>
                <input type="text" id="messageTitle" placeholder="Enter message title..." style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.3s; font-family: inherit;" onfocus="this.style.borderColor='#2c71b7'; this.style.boxShadow='0 0 0 3px rgba(44, 113, 183, 0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" maxlength="200">
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 700; color: #1e293b; margin-bottom: 8px; font-size: 15px;">
                    <i class="fas fa-comment-alt" style="color: #2c71b7; margin-right: 8px;"></i>Message
                </label>
                <textarea id="messageBody" placeholder="Type your message here..." rows="6" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.3s; resize: vertical; min-height: 120px; font-family: inherit; line-height: 1.6;" onfocus="this.style.borderColor='#2c71b7'; this.style.boxShadow='0 0 0 3px rgba(44, 113, 183, 0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'" maxlength="1000"></textarea>
                <div style="text-align: right; color: #64748b; font-size: 12px; margin-top: 4px;">
                    <span id="charCount">0</span>/1000 characters
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px;">
                <button onclick="closeMessageModal()" style="flex: 1; padding: 14px; background: #f1f5f9; color: #475569; border: none; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button id="sendMessageBtn" onclick="sendMessageToAdmin()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #2c71b7 0%, #1e5a9a 100%); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(44, 113, 183, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(44, 113, 183, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(44, 113, 183, 0.3)'">
                    <i class="fas fa-paper-plane"></i> Send Message
                </button>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
    // Character counter for message body
    document.addEventListener('DOMContentLoaded', function() {
        const messageBody = document.getElementById('messageBody');
        const charCount = document.getElementById('charCount');
        
        if (messageBody && charCount) {
            messageBody.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
        }
    });
</script>

{% endblock %}

