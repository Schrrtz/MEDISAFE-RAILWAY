{% extends 'base.html' %}
{% load static %}

{% block title %}Vital Signs - Medisafe Diagnostic Center{% endblock %}

{% block extra_css %}
<style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f8fafc 100%);
            color: #1e293b;
            min-height: 100vh;
        }

        html {
            height: 100%;
        }
        
        /* Fix notification panel alignment on vitals page */
        #notificationPanel {
            position: fixed !important;
            top: 70px !important;
            right: 20px !important;
            margin-top: 0 !important;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Patient Info Card */
        .patient-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 2px 12px rgba(44, 113, 183, 0.12);
            margin-bottom: 24px;
            border-left: 5px solid #2c71b7;
            transition: all 0.3s ease;
        }

        .patient-card:hover {
            box-shadow: 0 6px 24px rgba(44, 113, 183, 0.18);
        }

        .patient-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f9ff;
        }

        .patient-photo {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2c71b7, #60a5fa);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 16px rgba(44, 113, 183, 0.3);
            border: 4px solid white;
        }

        .patient-info h2 {
            margin: 0 0 6px 0;
            font-size: 26px;
            font-weight: 700;
            color: #1e293b;
        }

        .patient-id {
            color: #64748b;
            font-size: 14px;
            margin: 0;
            font-weight: 500;
        }

        .patient-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .detail-item {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #bfdbfe;
            transition: all 0.2s ease;
        }

        .detail-item:hover {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: translateY(-2px);
        }

        .detail-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        /* Vital Signs Grid */
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .vital-card {
            background: white;
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid #f1f5f9;
        }

        .vital-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2c71b7, #60a5fa);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .vital-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(44, 113, 183, 0.15);
        }

        .vital-card:hover::before {
            opacity: 1;
        }

        .vital-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .vital-icon {
            font-size: 36px;
            margin-right: 12px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .vital-title {
            font-size: 15px;
            font-weight: 600;
            color: #64748b;
            margin: 0;
            letter-spacing: 0.3px;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            box-shadow: 0 0 8px currentColor;
        }

        .status-normal { 
            background: #22c55e;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.5);
        }
        .status-warning { 
            background: #f59e0b;
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.5);
        }
        .status-critical { 
            background: #ef4444;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
        }

        .vital-value {
            font-size: 42px;
            font-weight: 800;
            color: #1e293b;
            margin: 14px 0;
            line-height: 1;
        }

        .vital-unit {
            font-size: 16px;
            color: #64748b;
            font-weight: 500;
        }

        .vital-range {
            font-size: 13px;
            color: #64748b;
            margin-top: 12px;
            padding: 10px 14px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            border: 1px solid #bfdbfe;
            font-weight: 500;
        }

        .vital-trend {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
        }

        .trend-up { 
            color: #ef4444;
            animation: bounce 2s infinite;
        }
        .trend-down { 
            color: #22c55e;
            animation: bounce 2s infinite;
        }
        .trend-stable { 
            color: #64748b;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* Side Panel */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: white;
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 2px 12px rgba(44, 113, 183, 0.08);
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .panel-card:hover {
            box-shadow: 0 6px 20px rgba(44, 113, 183, 0.15);
        }

        .panel-title {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #1e293b;
            border-bottom: 3px solid #e0f2fe;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-item {
            display: flex;
            align-items: start;
            gap: 12px;
            padding: 14px;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-left: 4px solid #ef4444;
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .alert-item:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            transform: translateX(4px);
        }

        .alert-icon {
            color: #ef4444;
            font-size: 20px;
            margin-top: 2px;
        }

        .alert-text {
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
            line-height: 1.5;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 32px;
            color: #64748b;
            font-size: 14px;
            border-top: 2px solid #e0f2fe;
            margin-top: 40px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                padding: 16px;
            }
            
            .side-panel {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                padding: 12px;
            }
            
            .patient-card {
                padding: 20px;
            }
            
            .patient-header {
                flex-direction: column;
                text-align: center;
            }
            
            .patient-details {
                grid-template-columns: 1fr;
            }
            
            .vitals-grid {
                grid-template-columns: 1fr;
            }

            .vital-value {
                font-size: 36px;
            }

            .side-panel {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .vital-card {
                padding: 18px;
            }

            .vital-value {
                font-size: 32px;
            }
        }
  </style>
{% endblock %}

{% block content %}
  {% if not is_logged_in %}
      <!-- Welcome Section for Non-Logged-In Users -->
      <div style="background: linear-gradient(135deg, #2c71b7 0%, #1e5a9a 100%); color: white; padding: 40px; border-radius: 16px; margin: 24px; box-shadow: 0 8px 32px rgba(44, 113, 183, 0.3);">
        <div style="max-width: 900px; margin: 0 auto;">
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 24px;">
            <div style="flex: 1; min-width: 280px;">
              <h2 style="font-size: 32px; font-weight: 800; margin: 0 0 12px 0; line-height: 1.2;">ü©∫ Vital Signs Monitoring</h2>
              <h3 style="font-size: 20px; font-weight: 600; margin: 0 0 16px 0; opacity: 0.95;">Medisafe Diagnostic Center</h3>
              <p style="font-size: 16px; opacity: 0.9; margin: 0; line-height: 1.6;">Track your health metrics in real-time. Monitor heart rate, blood pressure, oxygen levels, and more with our advanced vital signs monitoring system.</p>
            </div>
            <button class="standard-login-btn" onclick="document.getElementById('loginBtn')?.click();" aria-label="Login to Monitor Vitals" style="background: white; color: #2c71b7; padding: 14px 28px; border-radius: 10px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'">
              <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>Login to Access
            </button>
          </div>
        </div>
      </div>
      
      <!-- Vital Monitoring Features for Non-Logged-In Users -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin: 24px; max-width: 1200px; margin-left: auto; margin-right: auto;">
        <div style="background: white; padding: 28px; border-radius: 14px; box-shadow: 0 4px 16px rgba(44,113,183,0.1); text-align: center; border-top: 4px solid #ef4444; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(44,113,183,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(44,113,183,0.1)'">
          <div style="font-size: 48px; margin-bottom: 12px;">‚ù§Ô∏è</div>
          <h4 style="color: #2c71b7; margin: 0 0 10px 0; font-size: 18px; font-weight: 700;">Heart Rate</h4>
          <p style="color: #64748b; font-size: 14px; margin: 0; line-height: 1.6;">Monitor your pulse and cardiovascular health in real-time</p>
        </div>
        <div style="background: white; padding: 28px; border-radius: 14px; box-shadow: 0 4px 16px rgba(44,113,183,0.1); text-align: center; border-top: 4px solid #f59e0b; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(44,113,183,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(44,113,183,0.1)'">
          <div style="font-size: 48px; margin-bottom: 12px;">üíâ</div>
          <h4 style="color: #2c71b7; margin: 0 0 10px 0; font-size: 18px; font-weight: 700;">Blood Pressure</h4>
          <p style="color: #64748b; font-size: 14px; margin: 0; line-height: 1.6;">Track systolic and diastolic pressure levels</p>
        </div>
        <div style="background: white; padding: 28px; border-radius: 14px; box-shadow: 0 4px 16px rgba(44,113,183,0.1); text-align: center; border-top: 4px solid #22c55e; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(44,113,183,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(44,113,183,0.1)'">
          <div style="font-size: 48px; margin-bottom: 12px;">üå°Ô∏è</div>
          <h4 style="color: #2c71b7; margin: 0 0 10px 0; font-size: 18px; font-weight: 700;">Temperature</h4>
          <p style="color: #64748b; font-size: 14px; margin: 0; line-height: 1.6;">Monitor body temperature fluctuations</p>
        </div>
        <div style="background: white; padding: 28px; border-radius: 14px; box-shadow: 0 4px 16px rgba(44,113,183,0.1); text-align: center; border-top: 4px solid #3b82f6; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(44,113,183,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(44,113,183,0.1)'">
          <div style="font-size: 48px; margin-bottom: 12px;">ü´Å</div>
          <h4 style="color: #2c71b7; margin: 0 0 10px 0; font-size: 18px; font-weight: 700;">Oxygen Saturation</h4>
          <p style="color: #64748b; font-size: 14px; margin: 0; line-height: 1.6;">Track SpO‚ÇÇ levels and respiratory function</p>
        </div>
        <div style="background: white; padding: 28px; border-radius: 14px; box-shadow: 0 4px 16px rgba(44,113,183,0.1); text-align: center; border-top: 4px solid #8b5cf6; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(44,113,183,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(44,113,183,0.1)'">
          <div style="font-size: 48px; margin-bottom: 12px;">üí®</div>
          <h4 style="color: #2c71b7; margin: 0 0 10px 0; font-size: 18px; font-weight: 700;">Respiration Rate</h4>
          <p style="color: #64748b; font-size: 14px; margin: 0; line-height: 1.6;">Monitor breathing patterns and lung health</p>
        </div>
        <div style="background: white; padding: 28px; border-radius: 14px; box-shadow: 0 4px 16px rgba(44,113,183,0.1); text-align: center; border-top: 4px solid #ec4899; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(44,113,183,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(44,113,183,0.1)'">
          <div style="font-size: 48px; margin-bottom: 12px;">ü©∏</div>
          <h4 style="color: #2c71b7; margin: 0 0 10px 0; font-size: 18px; font-weight: 700;">Blood Glucose</h4>
          <p style="color: #64748b; font-size: 14px; margin: 0; line-height: 1.6;">Track blood sugar levels for diabetes management</p>
        </div>
      </div>
      
            <!-- Login Button now triggers standardized header login modal -->
  {% else %}
    <!-- Full Vitals Content for Logged-In Users -->
    <div style="min-height: 100vh; padding-bottom: 40px;">
        <!-- Header Banner -->
        <div style="background: linear-gradient(135deg, #2c71b7 0%, #1e5a9a 100%); padding: 32px 24px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(44, 113, 183, 0.25);">
            <div style="max-width: 1400px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="background: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <span style="font-size: 32px;">ü©∫</span>
                        </div>
                        <div>
                            <h1 style="color: white; font-size: 28px; font-weight: 800; margin: 0 0 4px 0; letter-spacing: -0.5px;">Vital Signs Monitor</h1>
                            <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin: 0; font-weight: 500;">Medisafe Diagnostic Center</p>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">
                        <div style="color: white; font-size: 13px; font-weight: 600; opacity: 0.9; margin-bottom: 2px;">Last Updated</div>
                        <div style="color: white; font-size: 16px; font-weight: 700;" id="currentTime"></div>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Main Content -->
            <main>
                <!-- Patient Info -->
                <div class="patient-card">
                    <div class="patient-header">
                        <div class="patient-photo">
                            {% if user_profile.photo_url %}
                            <img src="{{ user_profile.photo_url }}" alt="Profile" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                            {% else %}
                            {{ user_profile.first_name|default:user.username|slice:":1" }}{{ user_profile.last_name|default:""|slice:":1" }}
                            {% endif %}
                        </div>
                        <div class="patient-info">
                            <h2>{{ user_profile.first_name|default:user.username }} {{ user_profile.last_name }}</h2>
                            <p class="patient-id">Patient ID: {{ user.user_id }}</p>
                        </div>
                    </div>
                    <div class="patient-details">
                        <div class="detail-item">
                            <div class="detail-label">SEX</div>
                            <div class="detail-value">{% if user_profile.sex %}{{ user_profile.sex|title }}{% else %}N/A{% endif %}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">BIRTH DATE</div>
                            <div class="detail-value">{% if user_profile.birthday %}{{ user_profile.birthday|date:"M d, Y" }}{% else %}N/A{% endif %}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">CIVIL STATUS</div>
                            <div class="detail-value">{% if user_profile.civil_status %}{{ user_profile.civil_status|title }}{% else %}N/A{% endif %}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">MOBILE NUMBER</div>
                            <div class="detail-value">{% if user_profile.contact_number %}{{ user_profile.contact_number }}{% elif user_profile.phone_number %}{{ user_profile.phone_number }}{% else %}N/A{% endif %}</div>
                        </div>
                    </div>
                </div>

                <!-- Watch Vitals Section -->
                <div style="background: white; border-radius: 16px; padding: 20px 28px; box-shadow: 0 4px 16px rgba(44,113,183,0.1); margin-bottom: 24px; border-left: 4px solid #2c71b7;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 20px; flex: 1; min-width: 250px;">
                            <div style="font-size: 32px;">‚åö</div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; color: #64748b; font-weight: 600; margin-bottom: 4px;">WATCH ID</div>
                                <div id="watchDeviceId" style="font-size: 18px; color: #1e293b; font-weight: 700;">Loading...</div>
                            </div>
                        </div>
                        <button id="refreshVitalsBtn" onclick="refreshWatchVitals()" style="background: linear-gradient(135deg, #2c71b7 0%, #1e5a96 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(44,113,183,0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(44,113,183,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(44,113,183,0.3)'">
                            <i class="fas fa-sync-alt" id="refreshIcon"></i>
                            Refresh Vitals
                        </button>
                    </div>
                    <div id="lastUpdatedTime" style="font-size: 12px; color: #94a3b8; margin-top: 12px; text-align: right;">
                        Last updated: Never
                    </div>
                </div>

                <!-- Vital Signs Grid -->
                <div class="vitals-grid">
                    <!-- Heart Rate -->
                    <div class="vital-card">
                        <div class="vital-trend trend-stable" id="heartRateTrend">‚Üí</div>
                        <div class="vital-header">
                            <div style="display: flex; align-items: center;">
                                <span class="vital-icon">‚ù§Ô∏è</span>
                                <h3 class="vital-title">Heart Rate</h3>
                            </div>
                            <div class="status-indicator status-normal" id="heartRateStatus"></div>
                        </div>
                        <div class="vital-value" id="heartRateValue">-- <span class="vital-unit">bpm</span></div>
                        <div class="vital-range">Normal: 60-100 bpm</div>
                    </div>

                    <!-- Blood Pressure -->
                    <div class="vital-card">
                        <div class="vital-trend trend-stable" id="bloodPressureTrend">‚Üí</div>
                        <div class="vital-header">
                            <div style="display: flex; align-items: center;">
                                <span class="vital-icon">üíâ</span>
                                <h3 class="vital-title">Blood Pressure</h3>
                            </div>
                            <div class="status-indicator status-normal" id="bloodPressureStatus"></div>
                        </div>
                        <div class="vital-value" id="bloodPressureValue">--/-- <span class="vital-unit">mmHg</span></div>
                        <div class="vital-range">Normal: <120/80 mmHg</div>
                    </div>

                    <!-- Oxygen Saturation -->
                    <div class="vital-card">
                        <div class="vital-trend trend-stable" id="spo2Trend">‚Üí</div>
                        <div class="vital-header">
                            <div style="display: flex; align-items: center;">
                                <span class="vital-icon">ü´Å</span>
                                <h3 class="vital-title">Oxygen Saturation</h3>
                            </div>
                            <div class="status-indicator status-normal" id="spo2Status"></div>
                        </div>
                        <div class="vital-value" id="spo2Value">-- <span class="vital-unit">%</span></div>
                        <div class="vital-range">Normal: 95-100%</div>
                    </div>

                    <!-- Temperature -->
                    <div class="vital-card" style="opacity: 0.6; position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; background: #f59e0b; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; box-shadow: 0 2px 6px rgba(245,158,11,0.3);">Coming Soon</div>
                        <div class="vital-trend trend-stable">‚Üí</div>
                        <div class="vital-header">
                            <div style="display: flex; align-items: center;">
                                <span class="vital-icon">üå°Ô∏è</span>
                                <h3 class="vital-title">Temperature</h3>
                            </div>
                            <div class="status-indicator status-normal"></div>
                        </div>
                        <div class="vital-value">-- <span class="vital-unit">¬∞F</span></div>
                        <div class="vital-range">Normal: 97.8-99.1¬∞F</div>
                    </div>

                    <!-- Respiration Rate -->
                    <div class="vital-card" style="opacity: 0.6; position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; background: #f59e0b; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; box-shadow: 0 2px 6px rgba(245,158,11,0.3);">Coming Soon</div>
                        <div class="vital-trend trend-stable">‚Üí</div>
                        <div class="vital-header">
                            <div style="display: flex; align-items: center;">
                                <span class="vital-icon">üí®</span>
                                <h3 class="vital-title">Respiration Rate</h3>
                            </div>
                            <div class="status-indicator status-normal"></div>
                        </div>
                        <div class="vital-value">-- <span class="vital-unit">breaths/min</span></div>
                        <div class="vital-range">Normal: 12-20 breaths/min</div>
                    </div>

                    <!-- Blood Glucose -->
                    <div class="vital-card" style="opacity: 0.6; position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px; background: #f59e0b; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; box-shadow: 0 2px 6px rgba(245,158,11,0.3);">Coming Soon</div>
                        <div class="vital-trend trend-stable">‚Üí</div>
                        <div class="vital-header">
                            <div style="display: flex; align-items: center;">
                                <span class="vital-icon">ü©∏</span>
                                <h3 class="vital-title">Blood Glucose</h3>
                            </div>
                            <div class="status-indicator status-normal"></div>
                        </div>
                        <div class="vital-value">-- <span class="vital-unit">mg/dL</span></div>
                        <div class="vital-range">Normal: 70-140 mg/dL</div>
                    </div>
                </div>
            </main>

            <!-- Side Panel -->
            <aside class="side-panel">
                <!-- Alerts -->
                <div class="panel-card">
                    <h3 class="panel-title">üö® Active Alerts</h3>
                    <div id="activeAlertsList">
                        <!-- Dynamic alerts will be inserted here by JavaScript -->
                        <div class="alert-item" style="background: #f0fdf4; border-left: 3px solid #22c55e;">
                            <span class="alert-icon">‚úì</span>
                            <span class="alert-text" style="color: #22c55e;">All vitals within normal range</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Readings -->
                <div class="panel-card">
                    <h3 class="panel-title">üìä Recent Readings</h3>
                    <div id="recentReadingsList" style="font-size: 14px; color: #1e293b;">
                        <!-- Current Reading -->
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #2c71b7;">
                            <div style="font-weight: 700; color: #2c71b7; margin-bottom: 8px; font-size: 13px;">Current Reading</div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="color: #64748b; font-size: 13px;">Heart Rate</span>
                                <span id="recentHR" style="font-weight: 700; color: #1e293b;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="color: #64748b; font-size: 13px;">Blood Pressure</span>
                                <span id="recentBP" style="font-weight: 700; color: #1e293b;">--/--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="color: #64748b; font-size: 13px;">Oxygen Saturation</span>
                                <span id="recentSpO2" style="font-weight: 700; color: #1e293b;">--</span>
                            </div>
                            <div style="text-align: center; padding-top: 8px; margin-top: 8px; border-top: 1px solid #e0f2fe;">
                                <span id="recentReadingTime" style="color: #94a3b8; font-size: 11px; font-style: italic;">No recent data</span>
                            </div>
                        </div>
                        <!-- Previous Reading -->
                        <div id="previousReadingSection" style="background: #f8fafc; padding: 12px; border-radius: 8px; border-left: 3px solid #94a3b8; display: none;">
                            <div style="font-weight: 700; color: #64748b; margin-bottom: 8px; font-size: 13px;">Previous Reading</div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="color: #94a3b8; font-size: 13px;">Heart Rate</span>
                                <span id="previousHR" style="font-weight: 600; color: #64748b;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="color: #94a3b8; font-size: 13px;">Blood Pressure</span>
                                <span id="previousBP" style="font-weight: 600; color: #64748b;">--/--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                <span style="color: #94a3b8; font-size: 13px;">Oxygen Saturation</span>
                                <span id="previousSpO2" style="font-weight: 600; color: #64748b;">--</span>
                            </div>
                            <div style="text-align: center; padding-top: 8px; margin-top: 8px; border-top: 1px solid #e2e8f0;">
                                <span id="previousReadingTime" style="color: #94a3b8; font-size: 11px; font-style: italic;">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Medical Team -->
                <div class="panel-card">
                    <h3 class="panel-title">üë• Your Care Team</h3>
                    <div style="font-size: 14px; line-height: 1.6;">
                        {% if user_doctors %}
                            {% for doctor in user_doctors %}
                            <div style="padding: 14px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #2c71b7; transition: all 0.2s ease;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                                <div style="font-weight: 700; color: #1e293b; font-size: 15px; margin-bottom: 4px;">
                                    <i class="fas fa-user-md" style="color: #2c71b7; margin-right: 8px;"></i>
                                    Dr. {{ doctor.user.userprofile.first_name }} {{ doctor.user.userprofile.last_name }}
                                </div>
                                <div style="color: #64748b; font-size: 13px;">
                                    <i class="fas fa-briefcase-medical" style="margin-right: 6px;"></i>
                                    {% if doctor.specialization %}{{ doctor.specialization }}{% else %}General Practice{% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div style="padding: 12px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #2c71b7;">
                                <div style="font-weight: 700; color: #1e293b; margin-bottom: 4px;">Your Healthcare Provider</div>
                                <div style="color: #64748b; font-size: 13px;">Medisafe Diagnostic Center</div>
                            </div>
                        {% endif %}
                        <div style="padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #22c55e;">
                            <div style="font-weight: 700; color: #1e293b; margin-bottom: 4px;">üìû Emergency Contact</div>
                            <div style="color: #2c71b7; font-size: 14px; font-weight: 600;">0968 569 9664</div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="footer" style="margin: 40px 24px 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;">
                <span style="font-size: 24px;">üè•</span>
                <span style="font-size: 16px; font-weight: 700; color: #2c71b7;">Medisafe Diagnostic Center</span>
            </div>
            <p style="margin: 0; font-size: 14px; color: #64748b;">Powered by Advanced Healthcare Monitoring System</p>
            <p style="margin: 8px 0 0; font-size: 13px; color: #94a3b8;" id="footerTime">Loading...</p>
        </footer>
    </div>

    {% block extra_js %}{% endblock %}
    <script>
        // Update current time display
        function updateTime() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true
            };
            const timeString = now.toLocaleString('en-US', options).replace(',', ' ‚Ä¢');
            
            const headerTime = document.getElementById('currentTime');
            const footerTime = document.getElementById('footerTime');
            
            if (headerTime) {
                headerTime.textContent = timeString;
            }
            if (footerTime) {
                footerTime.textContent = `Last updated: ${now.toLocaleString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true
                })}`;
            }
        }
        
        // Update time immediately and every minute
        updateTime();
        setInterval(updateTime, 60000);

        // Update recent readings timestamps
        function updateReadingTimes() {
            const now = new Date();
            const times = [
                new Date(now - 30 * 60000),  // 30 minutes ago
                new Date(now - 45 * 60000),  // 45 minutes ago
                new Date(now - 60 * 60000),  // 1 hour ago
                new Date(now - 75 * 60000)   // 1 hour 15 min ago
            ];
            
            const labels = ['Heart Rate', 'Blood Pressure', 'Temperature', 'SpO‚ÇÇ'];
            
            times.forEach((time, index) => {
                const element = document.getElementById(`reading${index + 1}Time`);
                if (element) {
                    const timeStr = time.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    element.textContent = `${timeStr} - ${labels[index]}:`;
                }
            });
        }
        
        updateReadingTimes();
        setInterval(updateReadingTimes, 60000); // Update every minute

        // Simulate real-time vital signs updates with realistic variations
        function updateVitalSigns() {
            const vitalCards = document.querySelectorAll('.vital-card');
            
            vitalCards.forEach((card, index) => {
                const valueElement = card.querySelector('.vital-value');
                if (!valueElement) return;
                
                const currentText = valueElement.textContent.trim();
                let newValue = currentText;
                
                // Simulate small realistic variations
                if (index === 0) { // Heart Rate
                    const current = parseInt(currentText);
                    const variation = Math.floor(Math.random() * 5) - 2; // ¬±2 bpm
                    const newRate = Math.max(60, Math.min(100, current + variation));
                    newValue = `${newRate} <span class="vital-unit">bpm</span>`;
                } else if (index === 5) { // Blood Glucose
                    const current = parseInt(currentText);
                    const variation = Math.floor(Math.random() * 6) - 3; // ¬±3 mg/dL
                    const newGlucose = Math.max(140, Math.min(200, current + variation));
                    newValue = `${newGlucose} <span class="vital-unit">mg/dL</span>`;
                }
                
                valueElement.innerHTML = newValue;
            });
        }

        // Update vitals every 10 seconds (disabled in favor of watch vitals)
        // setInterval(updateVitalSigns, 10000);

        // Add smooth fade animation when values update
        const style = document.createElement('style');
        style.textContent = `
            .vital-value {
                transition: all 0.3s ease;
            }
            .vital-card {
                animation: fadeIn 0.5s ease;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Function to refresh watch vitals
        function refreshWatchVitals() {
            const refreshBtn = document.getElementById('refreshVitalsBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            const watchDeviceId = document.getElementById('watchDeviceId');
            const lastUpdatedTime = document.getElementById('lastUpdatedTime');
            
            // Disable button and show loading state
            refreshBtn.disabled = true;
            refreshIcon.style.animation = 'spin 1s linear infinite';
            
            fetch('/api/watch-vitals/latest/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Watch vitals response:', data); // Debug log
                if (data.success && data.has_data) {
                    // Update Watch ID
                    watchDeviceId.textContent = data.data.device_id || 'N/A';
                    
                    // Update Heart Rate
                    if (data.data.heart_rate) {
                        document.getElementById('heartRateValue').innerHTML = `${data.data.heart_rate} <span class="vital-unit">bpm</span>`;
                        updateVitalStatus('heartRate', data.data.heart_rate, 60, 100);
                    }
                    
                    // Update Blood Pressure
                    if (data.data.systolic && data.data.diastolic) {
                        document.getElementById('bloodPressureValue').innerHTML = `${data.data.systolic}/${data.data.diastolic} <span class="vital-unit">mmHg</span>`;
                        updateBPStatus(data.data.systolic, data.data.diastolic);
                    }
                    
                    // Update SpO2
                    if (data.data.spo2) {
                        document.getElementById('spo2Value').innerHTML = `${data.data.spo2} <span class="vital-unit">%</span>`;
                        updateVitalStatus('spo2', data.data.spo2, 95, 100);
                    }
                    
                    // Update last updated time
                    lastUpdatedTime.textContent = `Last updated: ${data.data.last_updated}`;
                    
                    // Update Active Alerts based on vitals
                    updateActiveAlerts(data.data);
                    
                    // Update Recent Readings (with previous data if available)
                    updateRecentReadings(data.data, data.previous);
                    
                    // Show success feedback
                    showNotification('Vitals refreshed successfully!', 'success');
                } else {
                    watchDeviceId.textContent = 'No Data Available';
                    lastUpdatedTime.textContent = 'No watch vitals recorded yet';
                    
                    // Set default "no data" values
                    document.getElementById('heartRateValue').innerHTML = `-- <span class="vital-unit">bpm</span>`;
                    document.getElementById('bloodPressureValue').innerHTML = `--/-- <span class="vital-unit">mmHg</span>`;
                    document.getElementById('spo2Value').innerHTML = `-- <span class="vital-unit">%</span>`;
                    
                    // Clear Recent Readings
                    document.getElementById('recentHR').textContent = '--';
                    document.getElementById('recentBP').textContent = '--/--';
                    document.getElementById('recentSpO2').textContent = '--';
                    document.getElementById('recentReadingTime').textContent = 'No recent data';
                    
                    showNotification(data.message || 'No watch vitals data found for your account', 'info');
                }
            })
            .catch(error => {
                console.error('Error fetching watch vitals:', error);
                watchDeviceId.textContent = 'Error';
                lastUpdatedTime.textContent = 'Failed to load data';
                showNotification('Error connecting to server. Please try again.', 'error');
            })
            .finally(() => {
                // Re-enable button and stop loading animation
                refreshBtn.disabled = false;
                refreshIcon.style.animation = '';
            });
        }
        
        // Helper function to update vital status indicators
        function updateVitalStatus(type, value, minNormal, maxNormal) {
            const statusElement = document.getElementById(`${type}Status`);
            const trendElement = document.getElementById(`${type}Trend`);
            
            if (!statusElement) return;
            
            // Remove all status classes
            statusElement.classList.remove('status-normal', 'status-warning', 'status-critical');
            
            // Determine status
            if (value >= minNormal && value <= maxNormal) {
                statusElement.classList.add('status-normal');
                if (trendElement) {
                    trendElement.textContent = '‚Üí';
                    trendElement.className = 'vital-trend trend-stable';
                }
            } else if (value < minNormal - 10 || value > maxNormal + 10) {
                statusElement.classList.add('status-critical');
                if (trendElement) {
                    trendElement.textContent = value > maxNormal ? '‚Üó' : '‚Üò';
                    trendElement.className = value > maxNormal ? 'vital-trend trend-up' : 'vital-trend trend-down';
                }
            } else {
                statusElement.classList.add('status-warning');
                if (trendElement) {
                    trendElement.textContent = value > maxNormal ? '‚Üó' : '‚Üò';
                    trendElement.className = value > maxNormal ? 'vital-trend trend-up' : 'vital-trend trend-down';
                }
            }
        }
        
        // Helper function for blood pressure status
        function updateBPStatus(systolic, diastolic) {
            const statusElement = document.getElementById('bloodPressureStatus');
            const trendElement = document.getElementById('bloodPressureTrend');
            
            if (!statusElement) return;
            
            statusElement.classList.remove('status-normal', 'status-warning', 'status-critical');
            
            if (systolic < 120 && diastolic < 80) {
                statusElement.classList.add('status-normal');
                if (trendElement) {
                    trendElement.textContent = '‚Üí';
                    trendElement.className = 'vital-trend trend-stable';
                }
            } else if (systolic >= 140 || diastolic >= 90) {
                statusElement.classList.add('status-critical');
                if (trendElement) {
                    trendElement.textContent = '‚Üó';
                    trendElement.className = 'vital-trend trend-up';
                }
            } else {
                statusElement.classList.add('status-warning');
                if (trendElement) {
                    trendElement.textContent = '‚Üó';
                    trendElement.className = 'vital-trend trend-up';
                }
            }
        }
        
        // Function to update Active Alerts based on vitals
        function updateActiveAlerts(vitalsData) {
            const alertsList = document.getElementById('activeAlertsList');
            const alerts = [];
            
            // Check Heart Rate
            if (vitalsData.heart_rate) {
                if (vitalsData.heart_rate < 50) {
                    alerts.push({icon: 'üî¥', text: 'Low heart rate detected', color: '#ef4444'});
                } else if (vitalsData.heart_rate > 100) {
                    alerts.push({icon: '‚ö†Ô∏è', text: 'Elevated heart rate detected', color: '#f59e0b'});
                }
            }
            
            // Check Blood Pressure
            if (vitalsData.systolic && vitalsData.diastolic) {
                if (vitalsData.systolic >= 140 || vitalsData.diastolic >= 90) {
                    alerts.push({icon: 'üî¥', text: 'High blood pressure detected', color: '#ef4444'});
                } else if (vitalsData.systolic >= 120 || vitalsData.diastolic >= 80) {
                    alerts.push({icon: '‚ö†Ô∏è', text: 'Elevated blood pressure', color: '#f59e0b'});
                } else if (vitalsData.systolic < 90 || vitalsData.diastolic < 60) {
                    alerts.push({icon: '‚ö†Ô∏è', text: 'Low blood pressure detected', color: '#f59e0b'});
                }
            }
            
            // Check SpO2
            if (vitalsData.spo2) {
                if (vitalsData.spo2 < 90) {
                    alerts.push({icon: 'üî¥', text: 'Critically low oxygen saturation', color: '#ef4444'});
                } else if (vitalsData.spo2 < 95) {
                    alerts.push({icon: '‚ö†Ô∏è', text: 'Low oxygen saturation', color: '#f59e0b'});
                }
            }
            
            // Update the alerts list
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="alert-item" style="background: #f0fdf4; border-left: 3px solid #22c55e;">
                        <span class="alert-icon">‚úì</span>
                        <span class="alert-text" style="color: #22c55e;">All vitals within normal range</span>
                    </div>
                `;
            } else {
                alertsList.innerHTML = alerts.map(alert => `
                    <div class="alert-item" style="background: ${alert.color === '#ef4444' ? '#fef2f2' : '#fef3c7'}; border-left: 3px solid ${alert.color};">
                        <span class="alert-icon">${alert.icon}</span>
                        <span class="alert-text" style="color: ${alert.color};">${alert.text}</span>
                    </div>
                `).join('');
            }
        }
        
        // Function to update Recent Readings
        function updateRecentReadings(vitalsData, previousData) {
            // Update current heart rate
            if (vitalsData.heart_rate) {
                document.getElementById('recentHR').innerHTML = `${vitalsData.heart_rate} <span style="font-weight: 400; font-size: 12px;">bpm</span>`;
            }
            
            // Update current blood pressure
            if (vitalsData.systolic && vitalsData.diastolic) {
                document.getElementById('recentBP').innerHTML = `${vitalsData.systolic}/${vitalsData.diastolic} <span style="font-weight: 400; font-size: 12px;">mmHg</span>`;
            }
            
            // Update current SpO2
            if (vitalsData.spo2) {
                document.getElementById('recentSpO2').innerHTML = `${vitalsData.spo2}<span style="font-weight: 400; font-size: 12px;">%</span>`;
            }
            
            // Update current timestamp
            if (vitalsData.last_updated) {
                document.getElementById('recentReadingTime').textContent = vitalsData.last_updated;
            }
            
            // Update previous reading if available
            const previousSection = document.getElementById('previousReadingSection');
            if (previousData) {
                previousSection.style.display = 'block';
                
                if (previousData.heart_rate) {
                    document.getElementById('previousHR').innerHTML = `${previousData.heart_rate} <span style="font-weight: 400; font-size: 12px;">bpm</span>`;
                }
                
                if (previousData.systolic && previousData.diastolic) {
                    document.getElementById('previousBP').innerHTML = `${previousData.systolic}/${previousData.diastolic} <span style="font-weight: 400; font-size: 12px;">mmHg</span>`;
                }
                
                if (previousData.spo2) {
                    document.getElementById('previousSpO2').innerHTML = `${previousData.spo2}<span style="font-weight: 400; font-size: 12px;">%</span>`;
                }
                
                if (previousData.timestamp) {
                    document.getElementById('previousReadingTime').textContent = previousData.timestamp;
                }
            } else {
                previousSection.style.display = 'none';
            }
        }
        
        // Simple notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#f59e0b'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Auto-refresh on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshWatchVitals();
        });
    </script>
    {% endif %}

    {# Removed duplicate login modal; base.html includes shared auth modals for guests #}

    <script>
        // Modal elements
        const loginBtn = document.getElementById('loginBtn');
        const loginModal = document.getElementById('loginModal');
        const closeLogin = document.getElementById('closeLogin');
        const loginForm = document.getElementById('loginForm');
        
        // Show modal with animation
        function showModal(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease-in';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 50);
        }

        // Hide modal with animation
        function hideModal(modal) {
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease-out';
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modal.style.opacity = '1';
            }, 300);
        }

        // Page no longer manages modal directly; base.html handles it
    </script>
{% endblock %}
